<!--
  Hộp chat Tư vấn Công tác xã hội tại Việt Nam
  Sử dụng Gemini API để cung cấp thông tin và tư vấn chuyên môn.
  Người dùng cần thay thế "YOUR_GEMINI_API_KEY_HERE" bằng Khóa AI thực tế của họ.
-->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbox Công tác xã hội</title>
    <!-- Tải Tailwind CSS CDN để tạo giao diện đẹp và responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Đảm bảo chatbox luôn nổi và ở góc dưới bên phải */
        #chat-widget-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            font-family: 'Inter', sans-serif;
        }

        /* Ẩn thanh cuộn mặc định, chỉ hiển thị khi cần */
        #chat-messages {
            height: 400px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* Định kiểu cho các bong bóng chat */
        .message-bubble {
            padding: 8px 12px;
            border-radius: 16px;
            max-width: 85%;
            margin-bottom: 10px;
            word-wrap: break-word;
        }

        .user-message {
            background-color: #3b82f6; /* Blue 500 */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .ai-message {
            background-color: #f3f4f6; /* Gray 100 */
            color: #1f2937; /* Gray 800 */
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        /* Hiệu ứng bóng mượt cho khung chat */
        #chat-window {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        /* Loading indicator */
        .loading-dots div {
            width: 8px;
            height: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots div:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots div:nth-child(2) { animation-delay: -0.16s; }
        .loading-dots div:nth-child(3) { animation-delay: 0s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body class="p-0 m-0">

    <div id="chat-widget-container">
        <!-- Nút mở/đóng chat -->
        <button id="chat-toggle-button"
            class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition duration-300 ease-in-out w-16 h-16 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
            </svg>
        </button>

        <!-- Cửa sổ Chat (mặc định ẩn) -->
        <div id="chat-window" class="hidden w-80 bg-white rounded-xl overflow-hidden shadow-2xl transition duration-300 transform translate-y-0 mt-4">

            <!-- Header -->
            <div class="bg-blue-600 text-white p-3 flex justify-between items-center rounded-t-xl">
                <h3 class="text-lg font-semibold">Tư vấn Công tác Xã hội</h3>
                <button onclick="document.getElementById('chat-window').classList.add('hidden'); document.getElementById('chat-toggle-button').classList.remove('hidden');" class="hover:bg-blue-700 p-1 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Khung nhập API Key -->
            <div id="api-key-setup" class="p-4 bg-yellow-50 text-gray-800 text-sm">
                <p class="font-bold mb-2">Cài đặt Khóa AI</p>
                <input type="password" id="api-key-input" placeholder="Nhập KeyAI của bạn" class="w-full p-2 border border-gray-300 rounded-md mb-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                <button id="save-key-button" class="w-full bg-green-500 hover:bg-green-600 text-white py-1.5 rounded-md font-medium transition duration-150">Lưu Khóa AI</button>
                <p class="mt-2 text-xs text-center text-gray-500">Key sẽ được lưu cục bộ trong trình duyệt.</p>
            </div>

            <!-- Khung tin nhắn -->
            <div id="chat-messages" class="flex flex-col p-4">
                <!-- Tin nhắn chào mừng -->
                <div class="ai-message self-start">
                    Chào bạn! Tôi là Trợ lý Tư vấn Công tác Xã hội, sẵn sàng hỗ trợ bạn về các vấn đề xã hội tại Việt Nam.
                </div>
            </div>

            <!-- Input gửi tin nhắn -->
            <div class="p-4 border-t border-gray-200">
                <div class="flex">
                    <input type="text" id="user-input" placeholder="Nhập câu hỏi của bạn..."
                        class="flex-grow p-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        disabled>
                    <button id="send-button"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-r-lg disabled:opacity-50"
                        disabled>
                        Gửi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Đảm bảo các biến toàn cục (Global Variables) của Canvas được khai báo
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Note: Không cần Firebase trong ví dụ này, chỉ dùng API Key.

        const API_BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models/';
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';

        const systemPrompt = `Bạn là một chuyên gia tư vấn trong lĩnh vực Công tác xã hội tại Việt Nam. Trả lời các câu hỏi của người dùng một cách chính xác, thân thiện, và dựa trên luật pháp cũng như thực tế xã hội Việt Nam. Duy trì một giọng văn chuyên nghiệp, đồng cảm và hỗ trợ. Khi không chắc chắn về thông tin, hãy nói rõ rằng bạn cần kiểm tra thêm và không đưa ra lời khuyên y tế hoặc pháp lý thay thế chuyên gia.`;

        let apiKey = '';
        let chatHistory = [];
        let isSending = false;
        let userInput = document.getElementById('user-input');
        let chatMessages = document.getElementById('chat-messages');
        let sendButton = document.getElementById('send-button');
        let saveKeyButton = document.getElementById('save-key-button');
        let apiKeyInput = document.getElementById('api-key-input');
        let apiKeySetup = document.getElementById('api-key-setup');

        // --- Xử lý Giao diện và API Key ---

        document.getElementById('chat-toggle-button').addEventListener('click', () => {
            const windowEl = document.getElementById('chat-window');
            windowEl.classList.toggle('hidden');
            document.getElementById('chat-toggle-button').classList.add('hidden');
            scrollToBottom();
        });

        saveKeyButton.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key) {
                // Lưu key vào localStorage (dùng trong trình duyệt)
                localStorage.setItem('geminiApiKey', key);
                apiKey = key;
                initChat();
            } else {
                displayMessage('Vui lòng nhập Key AI.', 'ai');
            }
        });

        function loadApiKey() {
            const storedKey = localStorage.getItem('geminiApiKey');
            if (storedKey) {
                apiKey = storedKey;
                apiKeyInput.value = storedKey;
                apiKeySetup.classList.add('hidden');
                userInput.disabled = false;
                sendButton.disabled = false;
            } else {
                apiKeySetup.classList.remove('hidden');
                userInput.disabled = true;
                sendButton.disabled = true;
                // Hiển thị thông báo khi chatbox mở lần đầu mà chưa có key
                displayMessage('Vui lòng nhập Khóa AI của bạn để bắt đầu trò chuyện.', 'ai');
            }
        }

        function initChat() {
            loadApiKey();
            if (apiKey) {
                 apiKeySetup.classList.add('hidden');
                 userInput.disabled = false;
                 sendButton.disabled = false;
                 displayMessage('Chào mừng trở lại! Tôi là Trợ lý Tư vấn CTXH. Hãy hỏi tôi về các chính sách, quy trình, hoặc các tình huống công tác xã hội tại Việt Nam.', 'ai');
                 // Khởi tạo lịch sử chat với lời chào ban đầu nếu chưa có
                 if (chatHistory.length === 0) {
                     chatHistory.push({ role: "model", parts: [{ text: "Chào bạn! Tôi là Trợ lý Tư vấn Công tác Xã hội." }] });
                 }
            } else {
                 apiKeySetup.classList.remove('hidden');
            }
        }

        // --- Xử lý Tin nhắn và Giao tiếp API ---

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function displayMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${sender === 'user' ? 'user-message' : 'ai-message'}`;
            // Thay thế ký tự xuống dòng của Markdown bằng thẻ <br> để hiển thị đúng
            bubble.innerHTML = text.replace(/\n/g, '<br>');

            messageDiv.appendChild(bubble);
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showLoading() {
            const loadingHtml = `
                <div id="loading-indicator" class="ai-message loading-dots">
                    <div></div><div></div><div></div>
                </div>
            `;
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex justify-start`;
            messageDiv.innerHTML = loadingHtml;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function hideLoading() {
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.parentElement.remove();
            }
        }

        function sendMessage() {
            if (isSending || !apiKey) return;

            const text = userInput.value.trim();
            if (!text) return;

            // 1. Giao diện người dùng
            displayMessage(text, 'user');
            userInput.value = '';
            showLoading();
            isSending = true;
            sendButton.disabled = true;
            userInput.disabled = true;

            // 2. Thêm vào lịch sử chat
            chatHistory.push({ role: "user", parts: [{ text: text }] });

            // 3. Gọi API
            callGeminiAPI(text);
        }

        async function callGeminiAPI(query, retries = 0) {
            const url = `${API_BASE_URL}${MODEL_NAME}:generateContent?key=${apiKey}`;

            // Tạo payload với lịch sử chat, system instruction và grounding (tìm kiếm)
            const payload = {
                contents: chatHistory,
                // Bật Google Search Grounding để AI có thể truy cập thông tin cập nhật về CTXH/luật pháp Việt Nam
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retries < 3) {
                        // Xử lý lỗi Rate Limit (429) bằng Exponential Backoff
                        const delay = Math.pow(2, retries) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return callGeminiAPI(query, retries + 1);
                    }
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                let aiResponseText = "Xin lỗi, tôi không thể tạo ra phản hồi lúc này. Vui lòng thử lại sau.";

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    aiResponseText = candidate.content.parts[0].text;
                }

                // 4. Cập nhật giao diện và lịch sử chat
                hideLoading();
                displayMessage(aiResponseText, 'ai');

                // Cập nhật lịch sử chat chính thức sau khi nhận phản hồi
                chatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });

            } catch (error) {
                console.error("Lỗi gọi Gemini API:", error);
                hideLoading();
                // Xóa tin nhắn cuối cùng của người dùng khỏi lịch sử để tránh lặp lỗi
                chatHistory.pop();
                displayMessage('Xin lỗi, đã xảy ra lỗi trong quá trình xử lý. Vui lòng kiểm tra Key AI và thử lại.', 'ai');

            } finally {
                isSending = false;
                sendButton.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            }
        }

        // Khởi tạo chat khi trang web được tải
        window.onload = initChat;
    </script>
</body>
</html>