<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbox Công tác xã hội</title>
    <!-- Tải Tailwind CSS CDN để tạo giao diện đẹp và responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Container chính, căn giữa nội dung trên trang */
        #chat-main-container {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            padding: 24px;
        }

        /* Khung tin nhắn */
        #chat-messages {
            height: 400px; /* Tăng chiều cao để tận dụng không gian */
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* Định kiểu cho các bong bóng chat */
        .message-bubble {
            padding: 8px 12px;
            border-radius: 16px;
            max-width: 85%;
            margin-bottom: 10px;
            word-wrap: break-word;
        }

        .user-message {
            background-color: #3b82f6; /* Blue 500 */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .ai-message {
            background-color: #f3f4f6; /* Gray 100 */
            color: #1f2937; /* Gray 800 */
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        /* Hiệu ứng bóng mượt cho khung chat */
        #chat-window {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        /* Loading indicator */
        .loading-dots div {
            width: 8px;
            height: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots div:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots div:nth-child(2) { animation-delay: -0.16s; }
        .loading-dots div:nth-child(3) { animation-delay: 0s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        /* Ẩn thanh cuộn trên một số trình duyệt, ưu tiên thiết kế tối giản */
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="chat-main-container" class="w-full">
        <!-- Wrapper giới hạn chiều rộng và căn giữa -->
        <div class="w-full max-w-xl">
            <h1 class="text-3xl font-extrabold text-blue-800 mb-6 text-center">
<a href="https://congtacxahoibox.com.vn/" target="_blank" title="Congtacxahoibox" rel="nofollow,noopener">Công tác xã hội Box.Com.Vn</a>
</h1>

            <!-- Cửa sổ Chat -->
            <div id="chat-window" class="w-full bg-white rounded-xl overflow-hidden shadow-2xl">

                <!-- Header -->
                <div class="bg-blue-600 text-white p-4 flex items-center rounded-t-xl">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                    </svg>
                    <h3 class="text-xl font-semibold">Trợ lý Chuyên gia Công tác xã hội</h3>
                </div>

                <!-- Khung tin nhắn -->
                <div id="chat-messages" class="flex flex-col p-4">
                    <!-- Tin nhắn chào mừng -->
                    <div class="ai-message self-start">
                        Chào bạn! Tôi là Trợ lý Tư vấn Công tác Xã hội, đã sẵn sàng hỗ trợ bạn về các vấn đề xã hội tại Việt Nam. Bạn có câu hỏi nào không?
                    </div>
                </div>

                <!-- Input gửi tin nhắn -->
                <div class="p-4 border-t border-gray-200">
                    <div class="flex">
                        <input type="text" id="user-input" placeholder="Nhập câu hỏi của bạn..."
                            class="flex-grow p-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="send-button"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-r-lg disabled:opacity-50">
                            Gửi
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Key AI đã được nhúng trực tiếp vào đây
        const apiKey = "AIzaSyCV-q8Xv1anjYGp6wUbXDz5gWwXU2EvigE";

        // Các biến toàn cục
        const API_BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models/';
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';
        const systemPrompt = 'Bạn là một chuyên gia tư vấn trong lĩnh vực Công tác xã hội tại Việt Nam. Trả lời các câu hỏi của người dùng một cách chính xác, thân thiện, và dựa trên luật pháp cũng như thực tế xã hội Việt Nam. Duy trì một giọng văn chuyên nghiệp, đồng cảm và hỗ trợ. Khi không chắc chắn về thông tin, hãy nói rõ rằng bạn cần kiểm tra thêm và không đưa ra lời khuyên y tế hoặc pháp lý thay thế chuyên gia.';

        let chatHistory = [];
        let isSending = false;

        // Lấy các phần tử DOM
        let userInput, chatMessages, sendButton;

        function initializeElements() {
            userInput = document.getElementById('user-input');
            chatMessages = document.getElementById('chat-messages');
            sendButton = document.getElementById('send-button');

            // Xử lý gửi tin nhắn
            if (sendButton) sendButton.addEventListener('click', sendMessage);
            if (userInput) userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

             // Khởi tạo lịch sử chat (tin nhắn chào mừng)
             if (chatHistory.length === 0) {
                 chatHistory.push({ role: "model", parts: [{ text: "Chào bạn! Tôi là Trợ lý Tư vấn Công tác Xã hội, đã sẵn sàng hỗ trợ bạn về các vấn đề xã hội tại Việt Nam. Bạn có câu hỏi nào không?" }] });
             }
        }

        // --- Xử lý Tin nhắn và Giao tiếp API ---

        function displayMessage(text, sender) {
            if (!chatMessages) return;
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex ' + (sender === 'user' ? 'justify-end' : 'justify-start');

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble ' + (sender === 'user' ? 'user-message' : 'ai-message');
            // Thay thế ký tự xuống dòng của Markdown bằng thẻ <br> để hiển thị đúng
            bubble.innerHTML = text.replace(/\n/g, '<br>');

            messageDiv.appendChild(bubble);
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function scrollToBottom() {
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        function showLoading() {
            if (!chatMessages) return;
            const loadingHtml =
                '<div id="loading-indicator" class="ai-message loading-dots">' +
                    '<div></div><div></div><div></div>' +
                '</div>';
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-start';
            messageDiv.innerHTML = loadingHtml;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function hideLoading() {
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.parentElement.remove();
            }
        }

        function sendMessage() {
            if (isSending || !apiKey || !userInput) return;

            const text = userInput.value.trim();
            if (!text) return;

            // 1. Giao diện người dùng
            displayMessage(text, 'user');
            userInput.value = '';
            showLoading();
            isSending = true;
            sendButton.disabled = true;
            userInput.disabled = true;

            // 2. Thêm vào lịch sử chat
            chatHistory.push({ role: "user", parts: [{ text: text }] });

            // 3. Gọi API
            callGeminiAPI(text);
        }

        async function callGeminiAPI(query, retries = 0) {
            const url = API_BASE_URL + MODEL_NAME + ':generateContent?key=' + apiKey;

            // Lấy lịch sử chat, loại bỏ System Prompt nếu có trong lịch sử (chỉ để trong systemInstruction)
            const contents = chatHistory.filter(item => item.role !== "system");

            const payload = {
                contents: contents,
                // Bật Google Search Grounding để lấy thông tin thực tế xã hội Việt Nam
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retries < 3) {
                        // Xử lý lỗi Rate Limit (429) bằng Exponential Backoff
                        const delay = Math.pow(2, retries) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return callGeminiAPI(query, retries + 1);
                    }
                    throw new Error('API Error: ' + response.status + ' ' + response.statusText);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                let aiResponseText = "Xin lỗi, tôi không thể tạo ra phản hồi lúc này. Vui lòng thử lại sau.";

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    aiResponseText = candidate.content.parts[0].text;
                }

                // 4. Cập nhật giao diện và lịch sử chat
                hideLoading();
                displayMessage(aiResponseText, 'ai');

                // Cập nhật lịch sử chat chính thức sau khi nhận phản hồi
                chatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });

            } catch (error) {
                console.error("Lỗi gọi Gemini API:", error);
                hideLoading();
                // Xóa tin nhắn cuối cùng của người dùng khỏi lịch sử để tránh lặp lỗi
                chatHistory.pop();
                displayMessage('Xin lỗi, đã xảy ra lỗi trong quá trình xử lý. Vui lòng thử lại.', 'ai');

            } finally {
                isSending = false;
                if (sendButton) sendButton.disabled = false;
                if (userInput) {
                    userInput.disabled = false;
                    userInput.focus();
                }
            }
        }

        // Chờ cho DOM tải xong trước khi khởi tạo
        document.addEventListener('DOMContentLoaded', () => {
            initializeElements();
        });
    </script>
</body>
</html>



